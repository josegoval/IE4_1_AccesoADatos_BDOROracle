 ---------------------
| CREACIÓN DE OBJETOS |
 ---------------------

	-- ASIGNATURA --

CREATE OR REPLACE TYPE TIPO_ASIGNATURA AS OBJECT (
	COD_ASIG NUMBER(4),
	NOMBRE VARCHAR2(80),
	TIPO VARCHAR(50),
	MEMBER FUNCTION VALIDAR_TIPO RETURN NUMBER
);

CREATE OR REPLACE TYPE BODY TIPO_ASIGNATURA AS
	MEMBER FUNCTION VALIDAR_TIPO RETURN NUMBER IS
	BEGIN
		IF TIPO = 'OPTATIVA' OR TIPO = 'OBLIGATORIA' OR TIPO = 'LIBRE CONFIGURACION'
			THEN RETURN 1;
		ELSE RETURN 0;
		END IF;
	END;
END;

	-- CURSO --

CREATE OR REPLACE TYPE TIPO_CURSO AS OBJECT (
	ID_CURSO NUMBER(4),
	DESCRIPCION VARCHAR2(60),
	NIVEL VARCHAR2(3),
	TURNO CHAR,
	MEMBER FUNCTION VALIDAR_TURNO RETURN NUMBER
);

CREATE OR REPLACE TYPE BODY TIPO_CURSO AS
	MEMBER FUNCTION VALIDAR_TURNO RETURN NUMBER IS
	BEGIN
		IF TURNO = 'D' OR TURNO = 'N'
			THEN RETURN 1;
		ELSE RETURN 0;
		END IF;
	END;
END;

	-- ALUMNO --

CREATE OR REPLACE TYPE TIPO_DIRECCION AS OBJECT (
	DIRECCION VARCHAR2(50),
	POBLACION VARCHAR2(50),
	CODPOSTAL NUMBER(5),
	PROVINCIA VARCHAR(40)
);

CREATE OR REPLACE TYPE TYPE_TELEFONOS AS VARRAY(2) OF VARCHAR2(15);

CREATE OR REPLACE TYPE TIPO_NOTAS AS OBJECT (
	ASIGNATURA REF TIPO_ASIGNATURA,
	NOTA1EV	NUMBER(4,2),
	NOTA2EV	NUMBER(4,2),
	NOTA3EV	NUMBER(4,2),
	NOTAFJUN NUMBER(4,2),
	NOTASEPT NUMBER(4,2)
);

CREATE OR REPLACE TYPE TIPO_TABLA_ANIDADA_NOTAS AS TABLE OF TIPO_NOTAS;

CREATE OR REPLACE TYPE TIPO_ALUMNO AS OBJECT (
	DNI VARCHAR2(10),
	NOMBRE VARCHAR2(50),
	DIRECCION TIPO_DIRECCION,
	TELEFONOS TYPE_TELEFONOS,
	FECHA_NAC DATE,
	CURSO REF TIPO_CURSO,
	TNOTAS TIPO_TABLA_ANIDADA_NOTAS
);


 --------------------
| CREACIÓN DE TABLAS |
 --------------------

CREATE TABLE TASIGNATURAS OF TIPO_ASIGNATURA (
	COD_ASIG PRIMARY KEY 
);

CREATE TABLE TCURSOS OF TIPO_CURSO (
	ID_CURSO PRIMARY KEY 
);

CREATE TABLE TALUMNOS OF TIPO_ALUMNO (
	DNI PRIMARY KEY 
)NESTED TABLE TNOTAS STORE AS TNOTAS_ANIDADA;


 ----------------------------------------
| CREACIÓN DE FUNCIONES Y PROCEDIMIENTOS |
 ----------------------------------------

	-- ALUMNO --

CREATE OR REPLACE FUNCTION CREATE_ALUMNO (
	DNI_IN IN VARCHAR2, 
	NOMBRE_IN IN VARCHAR2, 
	DIRECCION_IN IN VARCHAR2,
	POBLACION_IN IN VARCHAR2,
	CODPOSTAL_IN IN NUMBER,
	PROVINCIA_IN IN VARCHAR,
	TELEFONO1_IN IN VARCHAR2,
	TELEFONO2_IN IN VARCHAR2,
	FECHA_NAC_IN IN DATE,
	ID_CURSO_IN IN NUMBER
	) RETURN NUMBER
IS
   	REFERENCIA_CURSO REF TIPO_CURSO;
BEGIN
    	SELECT REF(C) INTO REFERENCIA_CURSO FROM TCURSOS C WHERE C.ID_CURSO = ID_CURSO_IN;

	INSERT INTO TALUMNOS (DNI, NOMBRE, DIRECCION, TELEFONOS, FECHA_NAC, CURSO) VALUES (
		DNI_IN, NOMBRE_IN, TIPO_DIRECCION (DIRECCION_IN, POBLACION_IN, CODPOSTAL_IN, PROVINCIA_IN),
		TYPE_TELEFONOS(TELEFONO1_IN, TELEFONO2_IN), FECHA_NAC_IN, REFERENCIA_CURSO);
	RETURN 1;
EXCEPTION
	WHEN OTHERS THEN
		RETURN 0;	
END;


CREATE OR REPLACE FUNCTION MATRICULAR_ASIGNATURA (DNI_ALUMNO_IN IN VARCHAR2, COD_ASIG_IN IN NUMBER)
	RETURN NUMBER
IS
	REFERENCIA_ASIGNATURA REF TIPO_ASIGNATURA;
	COD_ASIG_BUSCADA NUMBER;
BEGIN
	SELECT REF(A) INTO REFERENCIA_ASIGNATURA FROM TASIGNATURAS A WHERE A.COD_ASIG = COD_ASIG_IN;

	IF COD_ASIG_BUSCADA IS NOT NULL THEN
		SELECT N.ASIGNATURA.COD_ASIG INTO COD_ASIG_BUSCADA FROM THE 
			(SELECT AL.TNOTAS FROM TALUMNOS AL WHERE AL.DNI = DNI_ALUMNO_IN)N
			WHERE N.ASIGNATURA.COD_ASIG = COD_ASIG_IN;
	END IF;
	RETURN 0;
	
EXCEPTION
	WHEN NO_DATA_FOUND THEN
		INSERT INTO TABLE (SELECT TNOTAS FROM TALUMNOS WHERE DNI = DNI_ALUMNO_IN) VALUES (TIPO_NOTAS(
			REFERENCIA_ASIGNATURA, -1, -1, -1, -1, -1));
		RETURN 1;
	WHEN OTHERS THEN
		RETURN 0;
END;


	-- ASIGNATURA --

CREATE OR REPLACE FUNCTION CREATE_ASIGNATURA (
	COD_ASIG_IN IN NUMBER,
	NOMBRE_IN IN VARCHAR2,
	TIPO_IN IN VARCHAR2
	) RETURN NUMBER
IS
	OBJETO_ASIGNATURA TIPO_ASIGNATURA;
BEGIN
	OBJETO_ASIGNATURA := TIPO_ASIGNATURA(COD_ASIG_IN, NOMBRE_IN, TIPO_IN);
	
	IF OBJETO_ASIGNATURA.VALIDAR_TIPO = 1
		THEN INSERT INTO TASIGNATURAS VALUES (OBJETO_ASIGNATURA.COD_ASIG, OBJETO_ASIGNATURA.NOMBRE, OBJETO_ASIGNATURA.TIPO);
		RETURN 1;
	ELSE
		RETURN -1;
	END IF;
EXCEPTION
	WHEN OTHERS THEN
		RETURN 0;	
END;


	-- CURSO --

CREATE OR REPLACE FUNCTION CREATE_CURSO (
	ID_CURSO_IN NUMBER,
	DESCRIPCION_IN VARCHAR2,
	NIVEL_IN VARCHAR2,
	TURNO_IN CHAR
	) RETURN NUMBER
IS
	OBJETO_CURSO TIPO_CURSO;
BEGIN
	OBJETO_CURSO := TIPO_CURSO(ID_CURSO_IN, DESCRIPCION_IN, NIVEL_IN, TURNO_IN);
	
	IF OBJETO_CURSO.VALIDAR_TURNO = 1
		THEN INSERT INTO TCURSOS VALUES (OBJETO_CURSO.ID_CURSO, OBJETO_CURSO.DESCRIPCION, OBJETO_CURSO.NIVEL, OBJETO_CURSO.TURNO);
		RETURN 1;
	ELSE
		RETURN -1;
	END IF;
EXCEPTION
	WHEN OTHERS THEN
		RETURN 0;	
END;


https://www.oracletutorial.com/plsql-tutorial/plsql-function/